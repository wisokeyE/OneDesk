name: Release Portable ZIP

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
          include-prerelease: true

      - name: Restore
        run: dotnet restore OneDesk.csproj

      - name: Publish self-contained portable build
        run: dotnet publish OneDesk.csproj -c Release -r win-x64 --self-contained true -o artifacts/OneDesk-portable-sc

      - name: Publish framework-dependent portable build
        run: dotnet publish OneDesk.csproj -c Release -r win-x64 --self-contained false -p:UseAppHost=true -o artifacts/OneDesk-portable-fd

      - name: Package ZIP
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          $zipNameFd = "OneDesk-x64-portable-$version.zip"
          $zipNameSc = "OneDesk-x64-portable-sc-$version.zip"
          Compress-Archive -Path "artifacts/OneDesk-portable-sc/*" -DestinationPath "artifacts/$zipNameSc"
          Compress-Archive -Path "artifacts/OneDesk-portable-fd/*" -DestinationPath "artifacts/$zipNameFd"
          "RELEASE_TAG=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZIP_SC_PATH=artifacts/$zipNameSc" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZIP_FD_PATH=artifacts/$zipNameFd" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: OneDesk ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          files: |
            ${{ env.ZIP_SC_PATH }}
            ${{ env.ZIP_FD_PATH }}
