<ui:FluentWindow
    x:Class="OneDesk.Views.Windows.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:OneDesk.Views.Windows"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:OneDesk.Models"
    xmlns:pages="clr-namespace:OneDesk.Views.Pages"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="{Binding ViewModel.ApplicationTitle, Mode=OneWay}"
    Width="1100"
    Height="650"
    d:DataContext="{d:DesignInstance local:MainWindow,IsDesignTimeCreatable=True}"
    d:DesignHeight="450"
    d:DesignWidth="800"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    ExtendsContentIntoTitleBar="True"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    WindowBackdropType="Mica"
    WindowCornerPreference="Round"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <ui:NavigationView
            x:Name="RootNavigation"
            Grid.Row="1"
            Padding="42,0,42,0"
            BreadcrumbBar="{Binding ElementName=BreadcrumbBar}"
            FrameMargin="0"
            IsBackButtonVisible="Visible"
            IsPaneToggleVisible="True"
            MenuItemsSource="{Binding ViewModel.MenuItems, Mode=OneWay}"
            PaneDisplayMode="LeftFluent">
            <ui:NavigationView.Header>
                <ui:BreadcrumbBar x:Name="BreadcrumbBar" Margin="42,32,42,20" />
            </ui:NavigationView.Header>
            <ui:NavigationView.ContentOverlay>
                <Grid>
                    <ui:SnackbarPresenter x:Name="SnackbarPresenter" />
                </Grid>
            </ui:NavigationView.ContentOverlay>
            <ui:NavigationView.FooterMenuItems>
                <ui:Button
                    Width="60"
                    Height="60"
                    CornerRadius="30"
                    Command="{Binding ViewModel.AddUserCommand, Mode=OneWay}">
                    <ui:Button.Style>
                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ViewModel.UserInfoManager.UserInfos.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ui:Button.Style>
                    <ui:SymbolIcon Symbol="Add48" FontSize="26" />
                </ui:Button>
                <ui:Button
                    x:Name="UserButton"
                    Command="{Binding ViewModel.TogglePopupCommand}"
                    Width="60" Height="60" CornerRadius="30"
                    Background="Transparent" BorderBrush="Transparent" Foreground="Transparent">
                    <ui:Button.Style>
                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ViewModel.UserInfoManager.UserInfos.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ui:Button.Style>
                    <ui:Image CornerRadius="30" Source="{Binding ViewModel.UserInfoManager.ActivatedUserInfo.PhotoBitmap, FallbackValue={x:Null}}" />
                </ui:Button>
                <ui:NavigationViewItem
                    Content="Settings"
                    Icon="{ui:SymbolIcon Settings24}"
                    TargetPageType="{x:Type pages:SettingsPage}" />
                <Popup
                    Placement="Right"
                    PlacementTarget="{Binding ElementName=UserButton}"
                    IsOpen="{Binding ViewModel.PopupIsOpen, Mode=TwoWay}"
                    StaysOpen="False" AllowsTransparency="True">
                    <Border
                        Background="White"
                        CornerRadius="4"
                        BorderBrush="#E0E0E0"
                        BorderThickness="1"
                        Padding="8">
                        <Border.Effect>
                            <DropShadowEffect RenderingBias="Quality" BlurRadius="10" ShadowDepth="2" Color="#77000000" Opacity="0.6"/>
                        </Border.Effect>
                        <StackPanel>
                            <ui:ListView
                                SelectionChanged="OnSelectionChanged"
                                SelectionMode="Single"
                                SelectedItem="{Binding ViewModel.UserInfoManager.ActivatedUserInfo, Mode=OneWay}"
                                ItemsSource="{Binding ViewModel.UserInfoManager.UserInfos, Mode=OneWay}">
                                <ui:ListView.ItemTemplate>
                                    <DataTemplate DataType="{x:Type models:UserInfo}">
                                        <Grid Margin="8,0">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="*" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <ui:Image
                                                Grid.RowSpan="2"
                                                Width="32"
                                                Height="32"
                                                Margin="6"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                CornerRadius="30" Source="{Binding PhotoBitmap}" />
                                            <TextBlock
                                                Grid.Row="0"
                                                Grid.Column="1"
                                                Margin="12,6,0,0"
                                                FontWeight="Bold"
                                                Text="{Binding DisplayName, Mode=OneWay}" />
                                            <TextBlock
                                                Grid.Row="1"
                                                Grid.Column="1"
                                                Margin="12,0,0,6"
                                                Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                Text="{Binding Mail, Mode=OneWay}" />
                                        </Grid>
                                    </DataTemplate>
                                </ui:ListView.ItemTemplate>
                            </ui:ListView>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <ui:Button
                                    Grid.Column="0"
                                    HorizontalAlignment="Stretch"
                                    Background="#4CAF50"
                                    MouseOverBackground="#4CAF50"
                                    BorderBrush="#45A049"
                                    Foreground="White"
                                    Margin="0,4,2,0"
                                    Command="{Binding ViewModel.AddUserCommand, Mode=OneWay}"
                                    Content="登录新账号" />
                                <ui:Button
                                    Grid.Column="1"
                                    HorizontalAlignment="Stretch"
                                    Background="#F44336"
                                    MouseOverBackground="#F44336"
                                    BorderBrush="#D32F2F"
                                    Foreground="White"
                                    Margin="2,4,0,0"
                                    Command="{Binding ViewModel.RemoveCurrentUserCommand, Mode=OneWay}"
                                    Content="注销当前账号" />
                            </Grid>
                        </StackPanel>
                    </Border>
                </Popup>
            </ui:NavigationView.FooterMenuItems>
        </ui:NavigationView>

        <ContentPresenter
            x:Name="RootContentDialog"
            Grid.Row="0"
            Grid.RowSpan="2" />

        <ui:TitleBar
            x:Name="TitleBar"
            Title="{Binding ViewModel.ApplicationTitle}"
            Grid.Row="0"
            CloseWindowByDoubleClickOnIcon="True">
            <ui:TitleBar.Icon>
                <ui:ImageIcon Source="pack://application:,,,/Assets/wpfui-icon-256.png" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>
    </Grid>
</ui:FluentWindow>
